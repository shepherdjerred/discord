VERSION 0.8

deps:
  FROM ../../+deno
  COPY . packages/backend
  COPY ../data+src/ packages/data/
  WORKDIR packages/backend
  RUN --mount="type=cache,target=$DENO_DIR" deno cache src/index.ts

check:
  FROM +deps
  RUN --mount="type=cache,target=$DENO_DIR" deno check src/index.ts
  RUN --mount="type=cache,target=$DENO_DIR" deno lint
  RUN deno test -A --unstable

image:
  FROM +deps
  ARG EARTHLY_GIT_HASH
  ARG version=$EARTHLY_GIT_HASH
  ENTRYPOINT deno run -A --unstable-ffi src/index.ts
  SAVE IMAGE --push ghcr.io/shepherdjerred/glitter-boys:$version
