import { z } from "https://esm.sh/zod@3.22.4";
import { RankSchema } from "./rank.ts";
// @deno-types="npm:@types/lodash"
import _ from "npm:lodash@4.17.21";
import { match } from "https://esm.sh/ts-pattern@5.0.5";
import { PlayerConfig, PlayerConfigEntrySchema } from "./playerConfig.ts";

export type QueueType = z.infer<typeof QueueTypeSchema>;
export const QueueTypeSchema = z.enum(["solo", "flex", "aram", "urf"]);

// from https://static.developer.riotgames.com/docs/lol/queues.json
export function parseQueueType(input: number): QueueType | undefined {
  return match(input)
    .returnType<QueueType | undefined>()
    .with(420, () => "solo")
    .with(440, () => "flex")
    .with(450, () => "aram")
    .with(1900, () => "urf")
    .otherwise(() => undefined);
}

export type LoadingScreenPlayer = z.infer<typeof LoadingScreenPlayerSchema>;
export const LoadingScreenPlayerSchema = z.strictObject({
  player: PlayerConfigEntrySchema,
  rank: RankSchema.optional(),
});

export type LoadingScreenState = z.infer<typeof LoadingScreenStateSchema>;
export const LoadingScreenStateSchema = z.strictObject({
  // a way to uniquely identify this entry
  // generated by the application
  uuid: z.string(),
  // the time that this was added to the state
  added: z.string().pipe(z.coerce.date()),
  // the match id from the Riot API
  matchId: z.number(),
  queue: QueueTypeSchema.optional(),
  players: z.array(LoadingScreenPlayerSchema),
});

export type ApplicationState = z.infer<typeof ApplicationStateSchema>;
export const ApplicationStateSchema = z.strictObject({
  gamesStarted: z.array(LoadingScreenStateSchema),
});

export function getPlayersInGame(
  players: PlayerConfig,
  state: ApplicationState,
) {
  const playersInGame = _.flatMap(state.gamesStarted, (game) => game.players);
  return _.filter(players, (player) =>
    _.some(
      playersInGame,
      (matchPlayer) =>
        matchPlayer.player.league.leagueAccount.accountId ===
          player.league.leagueAccount.accountId,
    ));
}

export function getPlayersNotInGame(
  players: PlayerConfig,
  state: ApplicationState,
) {
  const playersInGame = _.flatMap(state.gamesStarted, (game) => game.players);
  return _.reject(players, (player) =>
    _.some(
      playersInGame,
      (matchPlayer) =>
        matchPlayer.player.league.leagueAccount.accountId ===
          player.league.leagueAccount.accountId,
    ));
}
